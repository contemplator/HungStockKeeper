name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Frontend Build ---
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install --legacy-peer-deps

    - name: Build Frontend
      run: |
        cd frontend
        npm run build -- --configuration production --base-href /hungStock/

    # --- Backend Build ---
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache-dependency-path: backend/go.sum

    - name: Build Backend Binary
      run: |
        cd backend
        go build -o server main.go

    # --- Deploy to Server ---
    - name: Create .env file
      run: |
        echo "${{ secrets.ENV_FILE }}" > backend/.env

    - name: Copy files via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "frontend/dist/,backend/server,backend/.env,db/migrations/"
        target: "/var/www/hungstockkeeper_temp"
        strip_components: 0

    - name: Deploy on Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # 1. 停止後端服務
          sudo systemctl stop hungstockkeeper

          # 2. 移動檔案到正式目錄
          # Frontend
          sudo rm -rf /var/www/hungstockkeeper/frontend/*
          sudo cp -r /var/www/hungstockkeeper_temp/frontend/dist/frontend/* /var/www/hungstockkeeper/frontend/
          
          # Backend
          sudo cp /var/www/hungstockkeeper_temp/backend/server /var/www/hungstockkeeper/backend/
          sudo cp /var/www/hungstockkeeper_temp/backend/.env /var/www/hungstockkeeper/backend/
          sudo chmod +x /var/www/hungstockkeeper/backend/server
          
          # Migrations
          sudo cp -r /var/www/hungstockkeeper_temp/db/migrations/* /var/www/hungstockkeeper/db/migrations/

          # 3. 清理暫存
          rm -rf /var/www/hungstockkeeper_temp

          # 4. 執行 Database Migration (需先在 Server 安裝 migrate tool)
          # migrate -path /var/www/hungstockkeeper/db/migrations -database "postgres://..." up
          
          # 5. 重啟服務
          sudo systemctl start hungstockkeeper
          sudo systemctl restart nginx