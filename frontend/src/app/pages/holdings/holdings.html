<div class="p-0 sm:p-4">
<p-toast [style]="{width: '90%', left: '5%', right: '5%'}"></p-toast>
  <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
  
  <!-- Header Section -->
  <div class="mb-4">
    <h2 class="text-xl font-bold text-gray-800">追蹤您的股票庫存與買入細節</h2>
    <p class="text-sm text-gray-500">Manage your portfolio efficiently</p>
  </div>

  <!-- Toolbar -->
  <div class="mb-4">
    <p-button label="新增庫存" icon="pi pi-plus" (click)="openNew()" styleClass="p-button-success"></p-button>
  </div>

  <!-- Data Table -->
  <p-table [value]="holdings" [loading]="loading" responsiveLayout="stack" [breakpoint]="'960px'" class="p-datatable-sm shadow-md rounded-lg overflow-hidden">
    <ng-template pTemplate="header">
      <tr>
        <th>Symbol</th>
        <th>Quantity</th>
        <th>Cost Basis</th>
        <th>Current Price</th>
        <th>Market Value</th>
        <th>P/L</th>
        <th>P/L %</th>
        <th>Purchase Date</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-holding>
      <tr>
        <td><span class="p-column-title font-bold">Symbol</span>{{ holding.symbol }}</td>
        <td><span class="p-column-title font-bold">Quantity</span>{{ holding.quantity }}</td>
        <td><span class="p-column-title font-bold">Cost Basis</span>{{ holding.cost_basis | currency }}</td>
        <td><span class="p-column-title font-bold">Current Price</span>{{ holding.current_price | currency }}</td>
        <td><span class="p-column-title font-bold">Market Value</span>{{ holding.market_value | currency }}</td>
        <td>
            <span class="p-column-title font-bold">P/L</span>
            <span [class.text-green-500]="holding.profit_loss > 0" [class.text-red-500]="holding.profit_loss < 0">
                {{ holding.profit_loss | currency }}
            </span>
        </td>
        <td>
            <span class="p-column-title font-bold">P/L %</span>
            <span [class.text-green-500]="holding.profit_loss_percent > 0" [class.text-red-500]="holding.profit_loss_percent < 0">
                {{ holding.profit_loss_percent | number:'1.2-2' }}%
            </span>
        </td>
        <td><span class="p-column-title font-bold">Date</span>{{ holding.purchase_date | date:'shortDate' }}</td>
        <td><span class="p-column-title font-bold">Note</span>{{ holding.note }}</td>
        <td class="flex !justify-end">
            <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded mr-2" severity="info" (click)="editHolding(holding)"></button>
            <button pButton pRipple icon="pi pi-trash" class="p-button-rounded" severity="danger" (click)="deleteHolding(holding)"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center p-4">No holdings found.</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Dialog -->
  <p-dialog [(visible)]="displayDialog" [style]="{width: '450px'}" header="Holding Details" [modal]="true" styleClass="p-fluid">
    <ng-template pTemplate="content">
      <div class="field mb-4">
        <label for="symbol" class="block mb-2 font-bold">Stock Symbol</label>
        <input type="text" pInputText id="symbol" [(ngModel)]="holding.symbol" required autofocus class="w-full" />
        <small class="p-error" *ngIf="submitted && !holding.symbol">Symbol is required.</small>
      </div>
      <div class="field mb-4">
        <label for="quantity" class="block mb-2 font-bold">Quantity</label>
        <p-inputNumber id="quantity" [(ngModel)]="holding.quantity" mode="decimal" [minFractionDigits]="0" [maxFractionDigits]="5" class="w-full"></p-inputNumber>
      </div>
      <div class="field mb-4">
        <label for="cost_basis" class="block mb-2 font-bold">Cost Basis (Price per share)</label>
        <p-inputNumber id="cost_basis" [(ngModel)]="holding.cost_basis" mode="currency" currency="USD" locale="en-US" class="w-full"></p-inputNumber>
      </div>
      <div class="field mb-4">
        <label for="purchase_date" class="block mb-2 font-bold">Purchase Date</label>
        <p-datepicker id="purchase_date" [(ngModel)]="holding.purchase_date" dateFormat="yy-mm-dd" appendTo="body" class="w-full" [inputStyleClass]="'w-full'"></p-datepicker>
      </div>
      <div class="field mb-4">
        <label for="brokerage" class="block mb-2 font-bold">Brokerage</label>
        <p-select id="brokerage" [options]="brokerages" [(ngModel)]="holding.brokerage_id" optionLabel="name" optionValue="id" placeholder="Select a Brokerage" appendTo="body" class="w-full"></p-select>
      </div>
      <div class="field mb-4">
        <label for="note" class="block mb-2 font-bold">Note</label>
        <textarea id="note" pTextarea [(ngModel)]="holding.note" rows="3" (autoResize)="true" class="w-full resize-none"></textarea>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
      <button pButton pRipple label="Save" icon="pi pi-check" class="p-button-text" (click)="saveHolding()"></button>
    </ng-template>
  </p-dialog>
</div>
